var BookIdentifier,BookID,BookTitle,BookAuthor,BookDewey,BookISBN,BookMetadata,UserIdentifier,UserID,UserName,UserUsername,UserEmail,UserGrade,UserMetadata,UserPassword,UserSearch,UserSearchResults,BorrowBookBtn,ReturnBookBtn,SaveBookBtn,RemoveBookBtn,AddBookBtn,GetBookBtn,SearchUserBtn,GetUserBtn,SaveUserBtn,RemoveUserBtn,AddUserBtn,ClassesOfItemsToHide=["Index","Account","Search","404","Login","AddBook","BorrowBook","EditBook","ReturnBook","EditUser","AddUser"],AllInputsToBeLocked=["BookIdentifier","BookID","BookTitle","BookAuthor","BookDewey","BookISBN","BookMetadata","UserIdentifier","UserID","UserName","UserUsername","UserEmail","UserGrade","UserMetadata","UserPassword","UserSearch"],ItemsToUnlock={AddBook:["BookID","BookTitle","BookAuthor","BookDewey","BookISBN","BookMetadata"],BorrowBook:["BookIdentifier","UserSearch","UserIdentifier"],EditBook:["BookIdentifier","BookTitle","BookAuthor","BookDewey","BookISBN","BookMetadata"],ReturnBook:["BookIdentifier"],EditUser:["UserSearch","UserIdentifier","UserName","UserUsername","UserEmail","UserGrade","UserMetadata"],AddUser:["UserID","UserName","UserUsername","UserEmail","UserGrade","UserPassword"]};function Show(e){for(var r=0;r<ClassesOfItemsToHide.length;r++)for(var o=document.getElementsByClassName(ClassesOfItemsToHide[r]+"Page"),t=0;t<o.length;t++)o[t].style.visibility="collapse",o[t].style.height="0px";for(o=document.getElementsByClassName(e+"Page"),r=0;r<o.length;r++)o[r].style.visibility="visible",o[r].style.height="auto",window.location.hash="#"+e;SetBook(),SetUser();for(r=0;r<AllInputsToBeLocked.length;r++){null!=(o=document.getElementById(AllInputsToBeLocked[r]))&&(o.readOnly=!0,o.disabled=!0)}if(ItemsToUnlock.hasOwnProperty(e))for(r=0;r<ItemsToUnlock[e].length;r++)document.getElementById(ItemsToUnlock[e][r]).readOnly=!1,document.getElementById(ItemsToUnlock[e][r]).disabled=!1}function CheckHandleError(e){return e.hasOwnProperty("error")?(ShowError(e.error),!1):e.hasOwnProperty("response")&&0==e.response?(ShowError('Unexpected internal error<br />Please contact you Administrator<br />You could also open an issue on <a href="https://github.com/Evangeliki-Scholi/Open-School-Library-Lite/issues">GitHub</a>'),!1):(e.hasOwnProperty("message")&&ShowInfo(e.message),!0)}const BOOKAPI_V1="/API/V1/Book.php",USERSAPI_V1="/API/V1/Users.php";function AddBook(){if(""!=BookID.value.trim())if(""!=BookTitle.value.trim())if(""!=BookAuthor.value.trim()){BookMetadata.value="{}";var e={type:"AddBook",Identifier:BookID.value,Title:BookTitle.value,Author:BookAuthor.value,Dewey:BookDewey.value,ISBN:BookISBN.value};$.post(BOOKAPI_V1,e,function(e){CheckHandleError(e)&&(SetBook(),ShowSuccess("Book succesfully added"))}).fail(function(){ShowError('Interal server error<br />You can open an issue on <a href="https://github.com/Evangeliki-Scholi/Open-School-Library-Lite/issues">GitHub</a>')})}else ShowError("Book Author is required");else ShowError("Book Title is required");else ShowError("Book Identifier is required")}function AddUser(){if(""!=UserID.value.trim())if(""!=UserName.value.trim())if(""!=UserUsername.value.trim())if('Please choose education "grade"'!=UserGrade.value)if(""!=UserPassword.value.trim()){UserMetadata.value="{}";var e={type:"AddUser",Identifier:UserID.value,Name:UserName.value,Username:UserUsername.value,Email:UserEmail.value,Password:sha512_256(UserPassword.value),Algo:"sha256",Grade:UserGrade.value,Metadata:UserMetadata.value};$.post(USERSAPI_V1,e,function(e){CheckHandleError(e)&&(SetUser(),ShowSuccess("User succesfully added"))}).fail(function(){ShowError('Interal server error<br />You can open an issue on <a href="https://github.com/Evangeliki-Scholi/Open-School-Library-Lite/issues">GitHub</a>')})}else ShowError("User Password is required");else ShowError("User Grade is required");else ShowError("User Username is required");else ShowError("User Name is required");else ShowError("User Identifier is required")}function BorrowBook(){""!=BookID.value&&""!=UserID.value?$.post(BOOKAPI_V1,{type:"BorrowBook",Identifier:BookID.value,UserID:UserID.value},function(e){CheckHandleError(e)&&(ShowSuccess("Book Successfully borrowed by "+UserName.value),SetBook(),SetUser())}).fail(function(){ShowError("Interal server error")}):ShowError("Book Identifier and User Identifier can not be empty")}function SetBook(e="",r="",o="",t="",n="",a=""){BookID.value=e,BookTitle.value=r,BookAuthor.value=o,BookDewey.value=t,BookISBN.value=n,BookMetadata.value=a}function FindBook(){""==BookIdentifier.value.trim()&&ShowInfo("Book Identifier can not be empty or whitespaces").return;var e={type:"GetBook",Identifier:BookIdentifier.value.trim()};$.post(BOOKAPI_V1,e,function(e){CheckHandleError(e)&&SetBook(e.Identifier,e.Title,e.Author,e.Dewey,e.ISBN,e.Metadata)}).fail(function(){ShowError('Interal server error<br />You can open an issue on <a href="https://github.com/Evangeliki-Scholi/Open-School-Library-Lite/issues">GitHub</a>')})}function SetUser(e="",r="",o="",t="",n='Please choose education "grade"',a=""){UserID.value=e,UserName.value=r,UserUsername.value=o,UserEmail.value=t,UserGrade.value=n,UserMetadata.value=a,UserPassword.value=""}function FindUser(){""==UserIdentifier.value.trim()&&ShowInfo("User Identifier can not be empty or whitespaces").return;var e={type:"GetUser",Identifier:UserIdentifier.value.trim()};$.post(USERSAPI_V1,e,function(e){CheckHandleError(e)&&SetUser(e.data.Identifier,e.data.Name,e.data.Username,e.data.Email,e.data.Grade,e.data.Metadata)}).fail(function(){ShowError('Interal server error<br />You can open an issue on <a href="https://github.com/Evangeliki-Scholi/Open-School-Library-Lite/issues">GitHub</a>')})}function SearchUser(){if(UserSearch.value.trim()<2)return ShowInfo("Search item can not be empty, whitespace or less than two characters"),!1;UserSearchResults.innerHTML="";var e={type:"SearchUsers",SearchTag:UserSearch.value.trim()};$.post(USERSAPI_V1,e,function(e){if(!CheckHandleError(e))return;if(0==e.data.length)return void ShowInfo("No users were found");const r=document.createElement("table");r.setAttribute("class","table table-bordered");var o=r.insertRow(-1),t=document.createElement("th");t.innerHTML="Identifier",o.append(t),(t=document.createElement("th")).innerHTML="Name",o.append(t),(t=document.createElement("th")).innerHTML="Grade",o.append(t),(t=document.createElement("th")).innerHTML="",o.append(t);for(var n=0;n<e.data.length;n++)o=r.insertRow(-1),(t=document.createElement("th")).innerHTML=e.data[n].Identifier,o.append(t),(t=document.createElement("th")).innerHTML=e.data[n].Name,o.append(t),(t=document.createElement("th")).innerHTML=e.data[n].Grade,o.append(t),(t=document.createElement("th")).innerHTML='<button class="btn btn-primary btn-block" onclick="UserIdentifier.value=\''+e.data[n].Identifier+"';FindUser();UserSearch.value='';UserSearchResults.innerHTML='';\">Select</button>",o.append(t);UserSearchResults.appendChild(r)}).fail(function(){ShowError('Interal server error<br />You can open an issue on <a href="https://github.com/Evangeliki-Scholi/Open-School-Library-Lite/issues">GitHub</a>')})}async function GetUserHashingAlgorithm(e){return await Promise.resolve($.post(USERSAPI_V1,{type:"GetAlgo",Username:e}))}async function LogIn(){var e=$("#LoginUsername").val(),r=$("#LoginPassword").val(),o=await GetUserHashingAlgorithm(e);if(o.hasOwnProperty("error"))return ShowError(o.error),!1;if(0==o.respone)return ShowError("An unexpected error occured"),!1;switch(o.data){case"sha256":r=sha512_256(r);break;case"sha512":r=sha512(r);break;default:return ShowError(o.data+"Unrecognizable hashing algorithm. Please contact server Admins."),!1}return $.post(USERSAPI_V1,{type:"LogIn",Username:e,Password:r},function(e){if(e.hasOwnProperty("error"))return ShowError(e.error),!1;1==e.response?window.location.href="index.php":ShowInfo("Wrong credentials")}).fail(function(){return ShowError("Webclient error"),!1}),!1}function LogOut(){$.post(USERSAPI_V1,{type:"LogOut"},function(e){CheckHandleError(e)&&(window.location.href="index.php")})}function PerformSearch(){if($("#tagBook").val().trim().length<2)return ShowInfo("Search item can not be empty, whitespace or less than two characters"),!1;const e=$("#tagBook").val();var r=-1;return $.post(BOOKAPI_V1,{type:"SearchBooks",SearchTag:e,Limit:20,Skip:0},function(e){try{if(1!=e.response)return ShowError("Internal server Error"),!1;if(0==e.data.length)return ShowInfo("No results were found"),!1;length=e.data.length;for(var o=[],t=0,n=0;n<length;n++)for(var a in e.data[n])-1===o.indexOf(a)&&("Availability"===a&&-1==r&&(r=t),o.push(a)),t++;var s=document.createElement("table");s.setAttribute("class","table table-bordered");var i=s.insertRow(-1);for(n=0;n<o.length;n++){var d=document.createElement("th");"Availability"===o[n]?d.innerHTML="Available":d.innerHTML=o[n],i.append(d)}for(n=0;n<length;n++){i=s.insertRow(-1);for(t=0;t<o.length;t++){var l=i.insertCell(-1);l.innerHTML=t!==r?e.data[n][o[t]]:0!=e.data[n][o[t]]?"Yes":"No"}}document.getElementById("searchPage").innerHTML="",document.getElementById("searchPage").appendChild(s),Show("Search")}catch{ShowIndex(),ShowError("An unexpected error occured")}return!1}).fail(function(){ShowIndex(),ShowError("Webclient Error")}),!1}function RemoveBook(){$.post(BOOKAPI_V1,{type:"RemoveBook",Identifier:BookID.value},function(e){CheckHandleError(e)&&(SetBook(),ShowSuccess("Book deleted sucessfully"))})}function RemoveUser(){""!=UserID.value?$.post(USERSAPI_V1,{type:"RemoveUser",Identifier:UserID.value},function(e){CheckHandleError(e)&&(ShowSuccess("User successfully removed"),SetUser())}).fail(function(){ShowError("WebClient error")}):ShowError("User Identifier can not be empty")}function ReturnBook(){""!=BookID.value?$.post(BOOKAPI_V1,{type:"ReturnBook",Identifier:BookID.value},function(e){CheckHandleError(e)&&(ShowSuccess("Book was successfully returned"),SetBook())}).fail(function(){return ShowError("Internal Server Error"),!1}):ShowError("Book Identifier can not be empty")}function SaveBookInfo(){if(""==BookID.value)return void ShowError("Book Identifier can not be empty");const e=BookMetadata.value;try{BookMetadata.value=JSON.stringify(JSON.parse(BookMetadata.value))}catch{return ShowInfo('Metadata field is not a valid JSON data.<br />Visit <a href="https://www.json.org/json-en.html" target="_blank">JSON.org</a> for more info.'),void(BookMetadata.value=e)}$.post(BOOKAPI_V1,{type:"EditBook",Identifier:BookID.value,Title:BookTitle.value,Author:BookAuthor.value,Dewey:BookDewey.value,ISBN:BookISBN.value,Metadata:BookMetadata.value},function(e){CheckHandleError(e)&&(ShowSuccess("Book data stored successfully"),SetBook(),FindBook())}).fail(function(){ShowError("Internal Server Error")})}function SaveInfos(){var e={type:"EditSelf"};e.Name=$("#AccountName").val(),e.Username=$("#AccountUsername").val(),e.Email=$("#AccountEmail").val();var r=$("#AccountNewPassword").val();void 0===r&&(r=""),""!=r&&(e.Password=sha512_256(r),e.Algo="sha256"),""!=e.Name&&""!=e.Username?$.post(USERSAPI_V1,e,function(e){try{e.hasOwnProperty("error")?ShowError(e.error):!0!==e.response?ShowError("There was a problem with changing your Informations"):(ShowSuccess("Your informations were updated successfully"),window.location.href="index.php"),$("AccountNewPassword").val("")}catch{return void ShowError("Internal server error")}}).fail(function(){ShowError("Webclient error")}):ShowError("Username and Name can not be empty")}function SaveUserInfo(){if(""!=UserID.value)if(""!=UserName.value)if(""!=UserUsername.value)if('Please choose education "grade"'!=UserGrade.value){try{UserMetadata.value=JSON.stringify(JSON.parse(UserMetadata.value))}catch{return void ShowInfo('Metadata field is not a valid JSON data.<br />Visit <a href="https://www.json.org/json-en.html" target="_blank">JSON.org</a> for more info.')}$.post(USERSAPI_V1,{type:"EditUser",Name:UserName.value,Username:UserUsername.value,Email:UserEmail.value,Identifier:UserID.value,Grade:UserGrade.value,Metadata:UserMetadata.value},function(e){CheckHandleError(e)&&(ShowSuccess("User data successfully updated"),FindUser())}).fail(function(){ShowError("Internal Server Error")})}else ShowError('Please choose education "grade"');else ShowError("User Username can not be empty");else ShowError("User Name can not be empty");else ShowError("User Identifier can not be empty")}$(function(){document.getElementById("poweredBy").innerHTML='Powered By <a href="https://github.com/Evangeliki-Scholi/Open-School-Library-Lite">Open School Library Lite</a>',document.getElementById("tagBook").focus(),BookIdentifier=document.getElementById("BookIdentifier"),BookID=document.getElementById("BookID"),BookTitle=document.getElementById("BookTitle"),BookAuthor=document.getElementById("BookAuthor"),BookDewey=document.getElementById("BookDewey"),BookISBN=document.getElementById("BookISBN"),BookMetadata=document.getElementById("BookMetadata"),UserIdentifier=document.getElementById("UserIdentifier"),UserID=document.getElementById("UserID"),UserName=document.getElementById("UserName"),UserUsername=document.getElementById("UserUsername"),UserEmail=document.getElementById("UserEmail"),UserGrade=document.getElementById("UserGrade"),UserMetadata=document.getElementById("UserMetadata"),UserPassword=document.getElementById("UserPassword"),UserSearch=document.getElementById("UserSearch"),UserSearchResults=document.getElementById("UserSearchResults"),BorrowBookBtn=document.getElementById("BorrowBookBtn"),ReturnBookBtn=document.getElementById("ReturnBookBtn"),SaveBookBtn=document.getElementById("SaveBookBtn"),RemoveBookBtn=document.getElementById("RemoveBookBtn"),AddBookBtn=document.getElementById("AddBookBtn"),GetBookBtn=document.getElementById("GetBookBtn"),SearchUserBtn=document.getElementById("SearchUserBtn"),GetUserBtn=document.getElementById("GetUserBtn"),SaveUserBtn=document.getElementById("SaveUserBtn"),RemoveUserBtn=document.getElementById("RemoveUserBtn"),AddUserBtn=document.getElementById("AddUserBtn"),window.location.hash&&Show(window.location.hash.substring(1)),document.getElementById("tagBook").addEventListener("keyup",function(e){"Enter"==e.code&&(e.preventDefault(),PerformSearch())}),$.post("GAPIPAL.php",{Plugin:"",c:"list"},function(e){if(CheckHandleError(e))for(var r=0;r<e.data.length;r++){var o=document.createElement("script");o.src="plugins/"+e.data[r]+"/assets/"+e.data[r]+".js",document.head.appendChild(o)}}),BookIdentifier.addEventListener("keyup",function(e){"Enter"==e.code&&(e.preventDefault(),GetBookBtn.click())}),UserIdentifier.addEventListener("keyup",function(e){"Enter"==e.code&&(e.preventDefault(),GetUserBtn.click())}),UserSearch.addEventListener("keyup",function(e){"Enter"==e.code&&(e.preventDefault(),SearchUserBtn.click())}),AddBookBtn.addEventListener("click",AddBook),AddUserBtn.addEventListener("click",AddUser),BorrowBookBtn.addEventListener("click",BorrowBook),GetBookBtn.addEventListener("click",FindBook),GetUserBtn.addEventListener("click",FindUser),RemoveBookBtn.addEventListener("click",RemoveBook),RemoveUserBtn.addEventListener("click",RemoveUser),ReturnBookBtn.addEventListener("click",ReturnBook),SaveBookBtn.addEventListener("click",SaveBookInfo),SaveUserBtn.addEventListener("click",SaveUserInfo),SearchUserBtn.addEventListener("click",SearchUser)});